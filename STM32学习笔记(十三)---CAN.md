# STM32学习笔记(十三)---CAN

[TOC]

## CAN协议

Controler Area Network（控制器局域网络）

### 物理层

CAN通信，是一种**半双工异步通信**，只具有CAN_High和CAN_Low两条信号线，共同构成一组差分信号线，以**差分信号**的形式进行通信。

1. 闭环总线网络

   总线最大长度位40m，通信速度最高为1Mbps，总线的两端各要求有一个120欧的电阻。

2. 开环总线网络

   最大传输距离为1km，最高通信速度为125kbps，两根总线独立不形成闭环，每根总线上各串有一个2.2千欧的电阻。

3. 通讯节点

   CAN总线上可以挂在多个通讯节点，节点之间的信号经过总线传输，实现节点间通讯。

4. 差分信号

   差分信号又称差模信号，使用差分信号传输时，需要两根信号线，这两个信号线的振幅相等，相位相反，通过两根信号线的电压差值来表示逻辑 0 和逻辑 1。 

   两个通讯节点同一时间，一个输出**显性电平**，一个输出**隐性电平**，类似于I2C总线的“线与”特性将使它处于显性电平的状态，显性电平的名字就是这样来的。

### 协议层

#### 1.CAN的波特率及位同步

CAN通讯没有时钟信号线，属于异步通信。各节点之间会像串口通讯那样，使用约定好的**波特率**进行通讯。CAN还会使用**位同步**的方式来抗干扰、吸收误差、实现对总线电平信号进行正确采样。

##### 位时序分解

CAN协议把每一个数据位的时序分解成SS段、PTS段、PBS1段、PBS2段。分解后最小的时间单位为Tq，一个完整的数据位由8~25个Tq组成。

![1566269109831](.\图片\1566269109831.png)

- SS段（SYSNC SEG）

  **同步段**：若通讯节点检测到总线上信号的跳变沿被包含在 SS 段的范围之内，则表示节点与总线的时序是同步的 ，SS段的大小固定为1Tq。

- PTS段（PROP SEG）

  **传播时间段**：这个时间段是用于补偿网络的物理延时时间。是总线上输入比较器延时和输出驱动器延时总和的两倍。 PTS 段的大小可以为 1~8Tq。 

- PBS1段（PHASE SEG1）

  **相位缓冲段**1：主要用来补偿边沿阶段的误差，它的时间长度在重新同步的时候可以加长。 PBS1 段的初始大小可以为 1~8Tq 

- PBS2段（PHASE SEG2）

  **相位缓冲段2**：也是用来补偿边沿阶段误差的，它的时间长度在重新同步时可以缩短。 PBS2 段的初始大小可以为 2~8Tq。 

##### 通讯的波特率

总线上的各个通讯节点只要约定好 1 个 Tq 的时间长度以及每一个数据位占据多少个Tq，就可以确定 CAN 通讯的波特率 。

#### 2. CAN的报文种类及结构

对数据、操作命令以及同步信号进行打包，打包后的这些内容称为报文。

##### 报文的种类

| 帧     | 帧用途                                             |
| ------ | -------------------------------------------------- |
| 数据帧 | 用于节点向外传送数据                               |
| 遥控帧 | 用于向远端节点请求数据                             |
| 错误帧 | 用于向远端节点通知校验错误，请求重新发送上一个数据 |
| 过载帧 | 用于通知远端节点：本节点尚未做好接收准备           |
| 帧间隔 | 用于将数据帧及遥控帧与前面的帧分离开来             |

##### 报文的结构

![1566295352662](.\图片\1566295352662.png)

##### 数据帧的结构详解

数据帧是CAN通讯中最主要、最复杂的报文。

![1566283873926](.\图片\1566283873926.png)

数据帧以一个显性位（逻辑0）开始，以7个连续的隐性位（逻辑1）结束，在他们中间分别有仲裁段、控制段、数据段、CRC段和ACK段。

- 帧起始

  SOF段（Start Of Frame），帧起始信号只有一个数据位，是一个显性电平，它用于通知各个节点将有数据传输，其他节点通过帧起始信号的电平跳变沿来进行硬同步。

- 仲裁段

  1. ID 位

     当同时有两个报文被发送时，总线会根据仲裁段的内容决定哪个数据包能被传输。

     <u>仲裁段的内容主要为本数据帧的ID信息</u>。数据帧具有标准帧和扩展帧两种格式，区别在于ID信息的长度，标准帧的ID为11位，扩展帧的ID为29位。

     总线上同时出现显性电平和隐性电平，总线的状态会被置位显性电平，CAN正是利用这个特性进行仲裁。<u>若两个节点同时竞争CAN总线的占有权，当发送报文时，若首先出现隐性电平则会失去对总线的占有权，进入接收状态。</u>

  2. RTR位（remote Transmission Request Bit）

     远程传输请求位，用来区分数据帧和遥控帧，当它为显性电平时表示数据帧，隐性电平时表示遥控帧。

  3. IDE位（Identifier Extension Bit）

     标识符扩展位，用于区分标准格式和扩展格式，当她为显性电平时表示标准格式，隐性电平时表示扩展格式。

  4. SRR位（Substitute Remote Request Bit）

     只存在与扩展格式，用于替代标准格式的RTR位。由于扩展帧中的 SRR 位为隐性位， RTR 在数据帧为显性位，所以在两个 ID相同的标准格式报文与扩展格式报文中，标准格式的优先级较高 

- 控制段

  <u>在控制段中的 r1 和 r0 为保留位，默认设置为显性位。</u>它最主要的是 DLC 段(DataLength Code)，译为数据长度码，它由 4 个数据位组成， 用于**表示本报文中的数据段含有多少个字节**， <u>DLC 段表示的数字为 0~8</u>。 

- 数据段

  数据段为数据帧的核心内容，他是节点要发送的原始信息，由0~8个字节组成，**MSB先行**。

- CRC段

  为了保证报文的正确传输， <u>CAN 的报文包含了一段 15 位的 CRC 校验码</u>，一旦接收节点算出的 CRC 码跟接收到的 CRC 码不同，则它会向发送节点反馈出错信息，利用错误帧请求它重新发送。**CRC 部分的计算一般由 CAN 控制器硬件完成，出错时的处理则由软件控制最大重发数。** 

  在 CRC 校验码之后，有一个 CRC 界定符，它为隐性位，主要作用是把 CRC 校验码与后面的 ACK 段间隔起来。 

- ACK段

  ACK 段包括一个 ACK 槽位，和 ACK 界定符位。类似 I2C 总线，**在 ACK 槽位中，发送节点发送的是隐性位，而接收节点则在这一位中发送显性位以示应答。**在 ACK 槽和帧结束之间由 ACK 界定符间隔开。 

- 帧结束（End Of Frame）

  由发送节点发送7个隐性位表示结束。

## STM32 CAN外设

![1566350893234](.\图片\1566350893234.png)

### 1. CAN控制器内核

#### 主控制寄存器CAN_MCR

1. DBF（Debug freeze）调试冻结功能

   使用它可设置 CAN 处于工作状态或禁止收发的状态，禁止收发时仍可访问接收 FIFO 中的数据。 

2. TTCM（Time triggered communication mode）时间触发模式

   用于配置 CAN 的时间触发通信模式，在此模式下， CAN 使用它内部定时器产生时间戳，并把它保存在CAN_RDTxR、 CAN_TDTxR 寄存器中。 内部定时器在每个 CAN 位时间累加，在接收和发送的帧起始位被采样，并生成时间戳。 

3. ABOM（Automatic bus-off management）自动离线管理

   它用于设置是否使用自动离线管理功能。当节点检测到它发送错误或接收错误超过一定值时，会自动进入离线状态，在离线状态中， CAN 不能接收或发送报文。<u>处于离线状态的时候，可以软件控制恢复或者直接使用这个自动离线管理功能，它会在适当的时候自动恢复。</u> 

4. AWUM（Automatic bus-off management）自动唤醒

   CAN 外设可以使用软件进入低功耗的睡眠模式，如果使能了这个自动唤醒功能，当 CAN 检测到总线活动的时候，会自动唤醒。 

5. NART（No automatic retransmission）自动重传

   设置这个功能后， 当报文发送失败时会自动重传至成功为止。若不使用这个功能，无论发送结果如何，消息只发送一次。 

6. RFLM（Receive FIFO locked mode）锁定模式

   该功能用于锁定接收 FIFO。 锁定后，当接收 FIFO 溢出时，会丢弃下一个接收的报文。若不锁定，则下一个接收到的报文会覆盖原报文 

7. TXFP（Transmit FIFO priority）报文发送优先级判定方法

   当 CAN 外设的发送邮箱中有多个待发送报文时，本功能可以控制它是根据**报文的 ID 优先级**还是**报文存进邮箱的顺序**来发送。 

#### 位时序寄存器CAN_BTR

用于配置测试模式、波特率以及各种位段内的段参数

1. 测试模式

   ![1566362152867](.\图片\1566362152867.png)

   - 正常模式

   - 静默模式

     静默模式下，它自己的输出端的逻辑 0 数据会直接传输到它自己的输入端，逻辑1 可以被发送到总线，所以它不能向总线发送显性位(逻辑 0)，只能发送隐性位(逻辑 1)。输入端可以从总线接收内容。由于它只可发送的隐性位不会强制影响总线的状态，所以把它称为静默模式。这种模式一般用于**监测**，它可以用于<u>分析总线上的流量</u>，但又不会因为发送显性位而影响总线。 

   - 回环模式

     回环模式下，它自己的输出端的所有内容都直接传输到自己的输入端，输出端的内容同时也会被传输到总线上，即也可使用总线监测它的发送内容。输入端只接收自己发送端的内容，不接收来自总线上的内容。使用回环模式可以进行**自检**。 

   - 回环静默模式

     自己的输出端的所有内容都直接传输到自己的输入端，并且不会向总线发送显性位影响总线，不能通过总线监测它的发送内容。输入端只接收自己发送端的内容，不接收来自总线上的内容。这种方式可以在**“热自检”**时使用，即自我检查的时候，不会干扰总线。 

2. 位时序及波特率

   

### 2. CAN发送邮箱

每个CAN外设有3个发送邮箱，每个发送邮箱包含标识符寄存器CAN_TIxR、数据长度寄存器CAN_TDTxR及2个数据寄存器CAN_TDLxR、CAN_TDHxR。

| 寄存器名                    | 功能                                     |
| --------------------------- | ---------------------------------------- |
| 标识符寄存器CAN_TIxR        | 存储待发送报文的ID、扩展ID、IDE位及RTR位 |
| 数据长度控制寄存器CAN_TDTxR | 存储待发送报文的DLC段                    |
| 低位数据寄存器CAN_TDLxR     | 存储待发送报文数据段的Data0-Data3的内容  |
| 高位数据寄存器CAN_TDHxR     | 存储待发送报文数据段的Data4-Data7的内容  |

当我们要使用 CAN 外设发送报文时，把报文的各个段分解，按位置写入到这些寄存器中，并对标识符寄存器 CAN_TIxR 中的发送请求寄存器位 TMIDxR_TXRQ 置 1，即可把数据发送出去。 

### 3. CAN接收FIFO

每个CAN外设有2个接收FIFO，每个FIFO有3个邮箱，即最多可以缓存6个接收到的报文。每个接收 FIFO 中包含有标识符寄存器 CAN_RIxR、数据长度控制寄存器 CAN_RDTxR 及 2 个数据寄存器 CAN_RDLxR、 CAN_RDHxR 。

| 寄存器名                 | 功能                                       |
| ------------------------ | ------------------------------------------ |
| 标识符寄存器CAN_RIxR     | 存储接收到的报文的ID、扩展ID、IDE位及RTR位 |
| 数据长度寄存器 CAN_RDTxR | 存储收到报文的DLC段                        |
| 低位数据寄存器CAN_RDLxR  | 存储收到报文数据段的Data0-Data3的内容      |
| 高位数据寄存器CAN_RDHxR  | 存储收到报文数据段的Data4-Data7的内容      |

通过中断或状态寄存器知道接收 FIFO 有数据后，我们再读取这些寄存器的值即可把接收到的报文加载到 STM32 的内存中 。

### 4. 验收筛选器

STM32CAN外设一共有28个筛选组，每个筛选器组有2个32位寄存器。可以通过调整**筛选ID的长度**及**过滤模式**来配置筛选器的工作模式。

**筛选ID的长度：**

1. 检查STDID[10:0]、EXTID[17:0]、IDE和RTR位，一共31位
2. 检查STDID[10:0]、RTR、IDE和EXTID[17:15]，一共16位

**过滤模式：**

1. 标识符列表模式，把要接收报文的ID列成一个表，要求报文ID与列表中的某一个标识符完全相同才可以接收。
2. 掩码模式，它可以 接收报文ID的某几位作为列表，这几位被称为掩码，只要掩码相同就符合要求。

通过配置筛选模式寄存器CAN_FM1R的FBMx位可以设置筛选器工作在哪个模式：

![1566365462990](.\图片\1566365462990.png)

每组筛选器包含CAN_FxR1和CAN_FxR2两个32位寄存器，用来存储要筛选的ID或掩码。

| 模式           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 32位掩码模式   | CAN_FxR1存储ID，CAN_FxR2存储哪个位必须要与CAN_FxR1中的ID一致，2个寄存器表示一组掩码 |
| 32位标识符模式 | CAN_FxR1和CAN_FxR2各存储1个ID，2个寄存器表示2个筛选的ID      |
| 16位掩码模式   | CAN_FxR1高16位存储ID，低16位存储哪个位必须要与高16位的ID一致；          CAN_FxR2高16位存储ID，低16位存储哪个位必须要与高16位的ID一致 |
| 16位标识符模式 | CAN_FxR1和CAN_FxR2各存储2个ID，2个寄存器表示4个筛选的ID      |

## CAN外设结构体

### CAN初始化结构体

```c
typedef struct {
	uint16_t CAN_Prescaler; /*配置 CAN 外设的时钟分频，可设置为 1-1024*/
	uint8_t CAN_Mode; /*配置 CAN 的工作模式，回环或正常模式*/
	uint8_t CAN_SJW; /*配置 SJW 极限值,即CAN重新同步时可增加或缩短的最大长度 */
	uint8_t CAN_BS1; /*配置 BS1 段长度*/
	uint8_t CAN_BS2; /*配置 BS2 段长度 */
	FunctionalState CAN_TTCM; /*是否使能 TTCM 时间触发功能*/
	FunctionalState CAN_ABOM; /*是否使能 ABOM 自动离线管理功能*/
	FunctionalState CAN_AWUM; /*是否使能 AWUM 自动唤醒功能 */
 	FunctionalState CAN_NART; /*是否使能 NART 自动重传功能*/
    FunctionalState CAN_RFLM; /*是否使能 RFLM 锁定 FIFO 功能*/
    FunctionalState CAN_TXFP; /*配置 TXFP 报文优先级的判定方法*/
 } CAN_InitTypeDef;
```

1. CAN_Prescaler

   本成员设置 CAN 外设的时钟分频，它可控制时间片 Tq 的时间长度，这里设置的值最终会减 1 后再写入 BRP 寄存器位，即前面介绍的 Tq 计算公式：

   ​                       **Tq = (BRP[9:0]+1) x Tpclk = CAN_Prescaler x Tpclk** 

### CAN发送接收结构体

```c
/** 
  * @brief  CAN Tx message structure definition  
  */
typedef struct
{
  uint32_t StdId;  //存储报文的标准标识符11位，0-0x7FF
  uint32_t ExtId;  //存储报文的扩展标识符29位，0-0x1FFFFFFF
  uint8_t IDE;     //存储标识符扩展标志，用于区分标准格式和扩展格式
  uint8_t RTR;     //远程传输请求位，用于区分数据帧和遥控帧
  uint8_t DLC;     //存取报文数据段的长度0-8，如果为遥控帧DLC=0
  uint8_t Data[8]; //存取报文数据段的内容
} CanTxMsg;
```

```c
/** 
  * @brief  CAN Rx message structure definition  
  */
typedef struct
{
  uint32_t StdId;  //存储报文的标准标识符11位，0-0x7FF
  uint32_t ExtId;  //存储报文的扩展标识符29位，0-0x1FFFFFFF
  uint8_t IDE;     //存储标识符扩展标志，用于区分标准格式和扩展格式
  uint8_t RTR;     //远程传输请求位，用于区分数据帧和遥控帧
  uint8_t DLC;     //存取报文数据段的长度0-8，如果为遥控帧DLC=0
  uint8_t Data[8]; //存取报文数据段的内容
  uint8_t FMI;     //存储了筛选器的编号
} CanRxMsg;
```

### CAN筛选器结构体

```c
/** 
  * @brief  CAN filter init structure definition
  */
typedef struct
{
  uint16_t CAN_FilterIdHigh;         //CAN_FxR1寄存器的高16位
  uint16_t CAN_FilterIdLow;          //CAN_FxR1寄存器的低16位
  uint16_t CAN_FilterMaskIdHigh;     //CAN_FxR2寄存器的高16位
  uint16_t CAN_FilterMaskIdLow;      //CAN_FxR2寄存器的低16位
  uint16_t CAN_FilterFIFOAssignment; //设置经过筛选后的数据存储到哪个接收FIFO
  uint8_t CAN_FilterNumber;          //筛选器编号，范围0-27
  uint8_t CAN_FilterMode;            //筛选器模式
  uint8_t CAN_FilterScale;           //设置筛选器的尺度
  FunctionalState CAN_FilterActivation; //是否使能本筛选器
} CAN_FilterInitTypeDef;
```




---
typora-root-url: ..
---

STM32学习笔记(十四)---ADC

## ADC简介

ADC：Analog to Digital 模拟数字转换器

1. 三个独立的ADC1/2/3，每个ADC有16个外部通道
2. 分辨率12/10/8/6位
3. ADC具有独立模式、双重模式、三重模式

## 功能框图

![1566973134433](/Image/1566973134433.png)

### 供电引脚

ADC输入范围为：V~ref-~ <= V~IN~ <= V~ref+~，由上述四个引脚决定。

### 输入通道

![1566973904571](/Image/1566973904571.png)

外部的16个输入通道在转换的时候又分为**规则通道**和**注入通道**。其中规则通道最多为16路，注入通道最多为4路。

**规则通道：**按顺序依次转换的通道

**注入通道：**在规则通道转换的时候强行插入。

### 转换顺序

#### 1. 规则序列：

规则序列有3个，分别是SQR3、SQR2、SQR1。如果通道2想要第一个转换，则SQ1[4:0]写2即可。<u>具体使用多少个通道，有SQR1的位SQL[3:0]决定，最多16个通道。</u>

![1566974316392](/Image/1566974316392.png)

#### 2.注入序列：

注入序列寄存器JSQR只有一个，最多支持4个通道，具体多少个由JL[2:0]决定。**如果 JL 的 值小于 4 的话，则 JSQR 跟 SQR 决定转换顺序的设置不一样，第一次转换的不是 JSQR1[4:0]，而是 JCQRx[4:0] ， x = （4-JL），跟 SQR 刚好相反。如果 JL=00（1 个转换），那么转换的顺序是从 JSQR4[4:0]开始，而不是从 JSQR1[4:0]开始，这个要注意，编程的时候不要搞错。当 JL 等于 4 时，跟 SQR 一样。** 

![1566974865728](/Image/1566974865728.png)

### 触发源

ADC转换可以由ADC控制寄存器（ADC_CR2）的ADON位来控制。也可以由外部事件触发转换（这个触发包括内部定时器和外部IO触发）

### 转换时间

#### ADC时钟：

ADC输入时钟ADC_CLK由PCLK2经过分频产生，最大值是36M。分频因子由ADC通用控制寄存器ADC_CCR的ADCPRE[1:0]设置，可设置的分频系数为2、4、6、8。一般我们设置PCLK2=HCLK/2=84M，<u>所以程序一般使用4分频或者6分频。</u>

#### 采样时间：

ADC 需要若干个 ADC_CLK 周期完成对输入的电压进行采样，采样的周期数可通过ADC 采样时间寄存器 ADC_SMPR1 和 ADC_SMPR2 中的 SMP[2:0]位设置， ADC_SMPR2控制的是通道 0~9， ADC_SMPR1 控制的是通道 10~17。每个通道可以分别用不同的时间采样。其中采样周期最小是 3 个，即如果我们要达到最快的采样，那么应该设置采样周期为 3 个周期，这里说的周期就是 1/ADC_CLK。 

ADC的总转换时间和ADC的输入时钟和采样时间有关：

T~conv~ = 采样时间 + 12个周期

### 数据寄存器

一切准备就绪后， ADC 转换后的数据根据转换组的不同，规则组的数据放在ADC_DR 寄存器，注入组的数据放在 JDRx。 如果是使用双重或者三重模式那规矩组的数据是存放在通用规矩寄存器 ADC_CDR 内的。 

#### 规则数据寄存器ADC_DR

ADC的规则数据寄存器ADC_DR只有一个，32位寄存器，只有低16位有效并且只是用于独立模式存放转换完成的数据。<u>ADC的最大精度为12位，ADC_DR是16位有效，因而允许数据存放时选择左对齐还是右对齐。</u>

注意：规则通道最多可以有16个，而规则数据寄存器只有一个。如果使用多通道转换，在一个通道转换完成，需要立即把数据取走或者开启DMA模式，把数据传到内存中，不然会造成数据的覆盖。

<u>最常用的做法是使用DMA传输，如果没有使用 DMA 传输，我们一般都需要使用 ADC 状态寄存器 ADC_SR 获取当前ADC 转换的进度状态，进而进行程序控制。</u> 

#### 注入数据寄存器ADC_JDRx

ADC注入组最多有4个通道，注入寄存器也有4个，一个通道对应一个寄存器。

#### 通用规则寄存器ADC_CDR

==ADC_CDR适用于双重或三重模式。==独立模式是指仅使用一个ADC。双重模式是指同时使用两个ADC（如ADC1和ADC2）。三重模式是指同时使用三个ADC**双重或三重模式下一般需要配合DMA数据传输使用。**

### 中断或DMA

#### 转换结束中断

数据转换结束后产生中断。分为**规则通道转换结束中断**和**注入通道转换结束中断**。

#### 模拟看门狗中断

开启了模拟看门够中断后，当被ADC转换的模拟电压低于低阈值或高于高阈值时，就会产生中断。

#### 溢出中断

如果发生了DMA传输数据丢失，会置位ADC状态寄存器ADC_SR的OVR位，如果同时使能了溢出中断，那么转换结束后会产生一个溢出中断。

#### DMA请求

规则通道和注入通道转换结束后，除了产生中断外，还可以产生DMA请求，把转换好的数据直接存储到内存里面。对于独立模式的多通道 AD 转换使用 DMA 传输非常有必须要，程序编程简化了很多。对于双重或三重模式使用 DMA 传输几乎可以说是必要的。

## ADC初始化结构体

```c
typedef struct {
uint32_t ADC_Resolution; //ADC 分辨率选择
FunctionalState ADC_ScanConvMode; //ADC 扫描选择
FunctionalState ADC_ContinuousConvMode; //ADC 连续转换模式选择
uint32_t ADC_ExternalTrigConvEdge; //ADC 外部触发极性
uint32_t ADC_ExternalTrigConv; //ADC 外部触发选择
uint32_t ADC_DataAlign; //输出数据对齐方式
uint8_t ADC_NbrOfChannel; //转换通道数目
} ADC_InitTypeDef;
```

**ADC_Resolution**：配置ADC分辨率，可选的有：12位、10位、8位、6位。ADC的分辨率越高，AD的数据精度越高，转换时间越长。

**ADC_ScanConvMode**：配置是否使用扫描模式，==如果是单通道AD使用DISABLE，如果是多通道AD使用ENABLE==。

**ADC_ContinuousConvMode**：配置自动连续转换还是单次转换（ENABLE/DISABLE），单次转换在完成一次转换后停止，需要手动控制才能重新启动转换。

**ADC_ExternalTrigConvEdge**：外部触发极性选择，==如果使能了外部触发==，可选的有禁止触发检测、上升沿触发检测、下降沿触发检测以及上升沿和下降沿触发检测。 

**ADC_ExternalTrigConv**：外部触发选择，==一般情况下使用软件自动触发==

**ADC_DataAlign**：转换结果数据对齐模式，==一般选择右对齐模式==

**ADC_NbrOfChannel**：ADC转换的通道数目

```c
typedef struct {
uint32_t ADC_Mode; //ADC 模式选择
uint32_t ADC_Prescaler; //ADC 分频系数
uint32_t ADC_DMAAccessMode; //DMA 模式配置
uint32_t ADC_TwoSamplingDelay; //采样延迟
} ADC_InitTypeDef;
```

**ADC_Mode**：ADC工作模式选择，可选的有独立模式（只是用1个ADC）、双重模式（使用2个ADC）、三重模式（3个ADC都是用）。

**ADC_Prescaler**：ADC分频系数，可选的有2，4，6，8。

**ADC_DMAAccessMode**：DMA模式设置，==只有双重或三重模式才需要设置==

**ADC_TwoSamplingDelay**：两个采样阶段之间的延时，==只适用于双重或三重模式==。

## 编程

### 独立模式下单通道采集（中断方式）

1. 初始换ADC引脚位**模拟输入**模式。（配置GPIO的流程，这里简化）
2. 开启ADC时钟
3. 配置公用初始化结构体：独立模式，4分频。
4. 配置初始化结构体：12位分辨率，1个通道，连续自动转换，软件触发，右对齐
5. 设置ADC转换通道顺序和采样时间
6. 配置使能ADC转换完成中断
7. 使能ADC
8. 开启软件触发ADC转换

### 独立模式下多通道采集（DMA方式）

1. 初始换ADC引脚位**模拟输入**模式。（配置GPIO的流程，这里简化）
2. 开启ADC时钟和DMA时钟
3. 配置DMA从规则数据寄存器将数据传输到指定的内存区域
4. 配置公用初始化结构体：独立模式，4分频。
5. 配置初始化结构体：12位分辨率，n个通道，连续自动转换，软件触发，右对齐
6. 设置ADC转换通道顺序和采样时间
7. 使能DMA请求，DMA在AD转换完成后自动将数据传输到指定的内存区域。
8. 使能ADC
9. 开启软件触发ADC转换
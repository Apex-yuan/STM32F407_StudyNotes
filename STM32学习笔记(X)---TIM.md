STM32学习笔记(X)---TIM

[TOC]

## 基本定时器（TIM6、TIM7）

- 基本定时器主要由两个功能：
  1. 基本定时功能，生成时基。
  2. 专门用于驱动数模转换器（DAC）

### 功能框图

![1565856152975](.\图片\1565856152975.png)

1. 基本定时器的时钟源只能来自内部时钟。
2. 计数过程主要包括：计数器寄存器（TIMx_CNT）、预分频寄存器（TIMx_PSC）、自动重装载寄存器（TIMx_ARR），这三个寄存器都是16位有效，可设置值为0-65535。fCK_CNT = fCK_PSC / (PSC[15:0] + 1)。

### 时基初始化结构体

```c
typedef struct
{
  uint16_t TIM_Prescaler;       //预分频因子  
  uint16_t TIM_CounterMode;     //计数模式  
  uint16_t TIM_Period;          //定时器周期
  uint16_t TIM_ClockDivision;   //时钟分频  
  uint8_t TIM_RepetitionCounter;//重复计数器  
} TIM_TimeBaseInitTypeDef;   
```

1. TIM_CounterMode：基本定时器只能是向上计数，即TIMx_CNT只能从0开始递增，并且无需初始化
2. TIM_ClockDivision：时钟分频，设置定时器时钟CK_INT频率和数字滤波器采样时钟频率分频比，基本定时器没有此功能
3. TIM_RepetitionCounter：重复计数器，属于高级定时器专用，利用它可以非常容易控制输出PWM的个数。

因此**基本定时器只需初始化两个参数（TIM_Prescaler和TIM_Period）即可**。

## 通用定时器

- 通用定时器在基本定时器的基础上引入了外部引脚，可以输入捕获和输出比较功能

## 高级定时器（TIM1、TIM8）

- 高级定时器又在通用定时器的基础上增加了可编程死区互补输出、重复计数器、带刹车（断路）功能。

### 功能框图

![1565858714439](.\图片\1565858714439.png)

#### 1. 时钟源

高级定时器共有四个时钟源可选：

- 内部时钟源CK_INT
- 外部时钟模式1：外部输入引脚TI下（x = 1，2，3，4）
- 外部时钟模式2：外部触发输入ETR
- 内部触发输入

#### 2. 控制器

高级定时器控制部分包括：

**触发控制器**：针对片内外设输出触发信号。

**从模式控制器**：可以控制计数器复位、启动、递增/递减、计数

**编码器接口**：专门针对编码器计数

#### 3. 时基单元

**预分频器PSC**：fCK_CNT等于fCK_PSC/(PSC[15:0]+1)，可以实现 1 至 65536 分频。 

**计数器CNT**：

- 递增计数模式：计数器从0开始计数，每来一个CK_CNT脉冲计数加一，直到计数器的值与自动重装载寄存器ARR的值相等。
- 递减计数模式：计数器从自动重装载寄存器ARR的值开始计数，每来一个CK_CNT脉冲计数减一，知道计数器的值为0。
- 中心对齐（递增/递减）模式：计数器从 0 开始递增计数，直到计数值等于(ARR-1)值生成计数器上
  溢事件，然后从 ARR 值开始递减计数直到 1 生成计数器下溢事件。 

**自动重装载寄存器ARR**：

**重复计数器RCR**：在基本/通用定时器发生上/下溢事件时直接就生成更新事件，但对于高级控制定时器
却不是这样，高级控制定时器在硬件结构上多出了重复计数器，在定时器发生上溢或下溢
事件是递减重复计数器的值，只有当重复计数器为 0 时才会生成更新事件。在发生 N+1 个
上溢或下溢事件(N 为 RCR 的值)时产生更新事件。 

#### 4.输入捕获

输入捕获可以对输入信号的上升沿，下降沿或双边沿进行捕获，可用来**测量输入信号的脉宽和测量PWM输入信号的频率和占空比**。

**注意:**如果捕获的脉宽的时间长度超过弄得捕获定时器的周期，就会发生溢出。

#### 5. 输出比较

#### 6. 断路功能

